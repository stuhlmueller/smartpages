<html>
  <head>
    <title>SmartPages</title>
    <link rel="stylesheet" href="assets/css/custom.css">
    <script src="assets/webppl/compiled/webppl.js"></script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/react/react.js"></script>
    <script src="bower_components/react/JSXTransformer.js"></script>
  </head>

  <body>

    <div id="linklist"></div>
    <div id="status"></div>

    <script type="text/jsx">
      /** @jsx React.DOM */


      ////////////////////////////////////////////////////////////////////
      // Data

      var withUniqueIdentifier = function(url){
           return url + "?" + Math.random();
      }

      var linkData = [
          { url: withUniqueIdentifier("http://www.buzzfeed.com/kaylayandoli/when-youre-here-youre-horrified"),
            title: "14 Restaurant Horror Stories That'll Make You Want To Order Takeout",
            score: 0.20,
            id: 0 },
          { url: withUniqueIdentifier("http://www.buzzfeed.com/abefg/we-turned-a-bunch-of-weird-snacks-into-ice-cream-flavors"),
            title: "We Turned A Bunch Of Weird Snacks Into Ice Cream Flavors",
            score: 0.20,
            id: 1 },
          { url: withUniqueIdentifier("http://www.buzzfeed.com/chelseamarshall/things-that-mean-something-different-when-you-have-a-cat"),
            title: "21 Words That Mean Something Different When You Have A Cat",
            score: 0.20,
            id: 2 },
          { url: withUniqueIdentifier("http://www.buzzfeed.com/samimain/dog-uses-sunroof-experiences-nirvana"),
            title: "Dog Uses Sunroof, Experiences Nirvana",
            score: 0.20,
            id: 3 },
          { url: withUniqueIdentifier("http://www.buzzfeed.com/samstryker/hoggy-hoggy-hogwarts-tell-us-secrets"),
            title: "27 Secrets Hogwarts Students Won't Tell You",
            score: 0.20,
            id: 4 }
      ];

      var numLinks = linkData.length;      
      var numUserTypes = 3;  // Number of distinct user prototypes
      
      // IDs of links clicked for each previous user
      var pastUsers = [
          [0, 1, 0, 1, 0],
          [1, 0, 1, 0, 1],
          [1, 1, 1, 0, 1],
          [2, 3, 2, 3, 2],
          [3, 2, 3, 2, 2],
          [3, 3, 3, 2, 2],
          [4, 4, 4, 4, 4],
          [4, 4, 4, 4, 4]
      ];
      
      // IDs of links clicked by current user
      var currentUser = [];


      ////////////////////////////////////////////////////////////////////
      // User interface

      var shortPercentage = function(number){
          return number.toPrecision(2).slice(2, 4) + "%";
      }

      var sorted = function(xs, cmp){
          var xs2 = xs.slice();
          xs2.sort(cmp);
          return xs2;
      }
      
      var ScoredLink = React.createClass({
          incrementClickCount: function(e){
              currentUser.push(this.props.data.id);
              setStatus("Click count updated, running predictor...");
              runPredictor();
          },
          render: function(){
              return (<div>                        
                        <span className="score">{shortPercentage(this.props.data.score)}</span>
                        <a href={this.props.data.url} onClick={this.incrementClickCount}>
                        {this.props.data.title}
                        </a>                      
                      </div>);
          }
      });

      var ScoredLinkList = React.createClass({          
          render: function(){
              var sortedLinks = sorted(
                  this.props.links, 
                  function(a, b){
                      return a.score < b.score;
                  });
              var linkNodes = sortedLinks.map(function(link){
                  return (<li className="scoredLink" key={link.id}>
                            <ScoredLink data={link} />
                         </li>);
              })
              return (<ul>
                  {linkNodes}
              </ul>);
          }
      });

      var linkList = React.renderComponent(
          <ScoredLinkList links={linkData} />, 
          document.getElementById('linklist'));

      var setStatus = function(status){
          $("#status").text(status);
      }


      ////////////////////////////////////////////////////////////////////
      // Model and inference
      
      // Top-level continuation
      var topK = function(x){
          console.log(x);
      };
      
      // Update link data, signal reordering and rerendering
      var processLinkScores = function(scores){          
          // Update link data
          for (var i=0; i < scores.length; i++) {
              linkData[i].score = scores[i];
          }
          // Reorder and rerender list of links
          linkList.setProps({links: linkData});
      }
      
      // Run inference to get new link scores
      var runPredictor = function(){
          setStatus("Running predictor...");
          predict(
              function(scores){
                  setStatus("Predictor done.");
                  processLinkScores(scores);
                  console.log(scores)
              },
              "", // address
              numLinks,
              numUserTypes,
              pastUsers,
              currentUser)
      }      
      
      // Load, compile and evaluate model code
      setStatus("Loading model code...");
      $.ajax({
          url: "models/rerank.wppl",
          success: function (modelCode){          
              setStatus("Compiling model...");
              var compiled = webppl.compile(modelCode, true);
              setStatus("Evaluating model...")
              eval.call(window, compiled);              
              runPredictor();
          }
      });
    </script>

  </body>
</html>
